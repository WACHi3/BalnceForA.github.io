<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏áA | AI Time Balance Planner</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{
      --white:#FFFFFF; --black:#121417;
      --bg:#F7FAFD; --line:#E6EAEE; --muted:#94A3B8; --text:#0F172A;
      --blue:#12A2FF; --blue-600:#0A86D4; --blue-soft:#EAF6FF;
      --green:#22C55E; --amber:#F59E0B; --sky:#38BDF8; --rose:#F43F5E; --violet:#8B5CF6;
      --teal:#14B8A6; --slate:#475569;
      --radius:16px; --radius-sm:12px; --gap:14px; --shadow:0 10px 28px rgba(18,162,255,.14);
      --day-col-width: 140px; --row-height: 56px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; background:linear-gradient(180deg,#FBFEFF 0%, #F2F6FB 100%); color:var(--text);
          font-family:'IBM Plex Sans Thai',sans-serif; line-height:1.65; }

    /* ---------- START PAGE ---------- */
    .start-page{ position:fixed; inset:0; z-index:1000; display:grid; place-items:center; background:#FFFFFF; transition:opacity .55s ease, transform .55s ease; }
    .start-page.hidden{ opacity:0; pointer-events:none; transform:scale(0.98) }
    .hero-min{ text-align:center; width:min(1100px,92vw); padding:32px 18px; }
    .hero-min .brand-badge{ width:64px; height:64px; margin:0 auto 18px; border-radius:18px; display:grid; place-items:center; background:linear-gradient(135deg,#12A2FF,#58C3FF); color:#fff; font:800 1.15rem 'Montserrat',sans-serif; box-shadow:0 14px 28px rgba(18,162,255,.25); }
    .hero-min h1{ margin:0 0 8px; font:800 clamp(2.2rem,5vw,4.2rem)/1.02 'Montserrat',sans-serif; letter-spacing:.2px; color:#19A2FF; }
    .hero-min p{ margin:0 0 28px; font-size:clamp(1rem,2.1vw,1.35rem); color:#6B7A90; font-weight:600; }
    .cta{ display:inline-flex; align-items:center; gap:10px; border:0; border-radius:14px; padding:14px 22px; background:var(--blue); color:#fff; font:700 1.05rem/1 'Montserrat',sans-serif; cursor:pointer; box-shadow:0 14px 28px rgba(18,162,255,.25); transition:transform .08s ease, box-shadow .18s ease, background-color .18s ease; }
    .cta:hover{ background:var(--blue-600); box-shadow:0 18px 34px rgba(10,134,212,.28) }
    .cta:active{ transform:translateY(1px) }
    .bg-blobs:before, .bg-blobs:after{ content:""; position:fixed; border-radius:999px; filter:blur(60px); opacity:.65; z-index:-1; }
    .bg-blobs:before{ width:520px; height:520px; top:-140px; right:-120px; background:radial-gradient(closest-side,#E3F5FF,#FFFFFF 70%); }
    .bg-blobs:after { width:520px; height:520px; bottom:-160px; left:-140px; background:radial-gradient(closest-side,#F2FFFB,#FFFFFF 70%); }

    /* ---------- TOP BAR ---------- */
    .topbar{ position:sticky; top:0; z-index:50; background:rgba(255,255,255,.85); backdrop-filter: blur(10px); border-bottom:1px solid var(--line) }
    .topbar-inner{ max-width:1200px; margin:auto; padding:14px 18px; display:flex; align-items:center; gap:14px; justify-content:space-between }
    .brand{ display:flex; align-items:center; gap:12px }
    .logo{ width:40px; height:40px; border-radius:12px; display:grid; place-items:center; color:#fff; background:linear-gradient(135deg,#12A2FF,#58C3FF); font-weight:800; font-family:'Montserrat',sans-serif }
    .title-wrap h1{ margin:0; font:800 1.2rem/1.2 'Montserrat',sans-serif }
    .title-wrap p{ margin:3px 0 0; font-size:.9rem; color:#7A8AA2 }
    .actions{ display:flex; gap:10px; flex-wrap:wrap }
    .btn{ border:0; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; transition:.18s transform,.18s box-shadow,.18s background-color }
    .btn:active{ transform:translateY(1px) }
    .btn-primary{ background:#0EA5E9; color:#fff }
    .btn-ghost{ background:#fff; color:#0F172A; border:1px solid var(--line) }
    .btn-danger{ background:#EF4444; color:#fff }

    .container{ max-width:1200px; margin:auto; padding:22px 18px }
    .dashboard{ display:grid; grid-template-columns:1fr auto; gap:var(--gap); align-items:center; background:#fff; border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); margin-bottom:14px }
    .legend{ background:#fff; border:1px solid var(--line); border-radius:var(--radius); padding:10px 14px; display:flex; gap:18px; align-items:center; flex-wrap:wrap; margin-bottom:12px; box-shadow:var(--shadow) }
    .legend-item{ display:flex; align-items:center; gap:8px; color:#334155; font-weight:700 }
    .color{ width:14px; height:14px; border-radius:3px; border:1px solid rgba(0,0,0,.08) }
    .c-class{ background:#0288D1 } .c-rest{ background:#22C55E } .c-read{ background:#F59E0B } .c-meal{ background:#14B8A6 } .c-social{ background:#8B5CF6 } .c-bed{ background:#475569; }

    .table-wrap{ overflow:auto; background:#fff; border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); position:relative }
    table.schedule-table{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; min-width:1120px }
    .col-day{ width:var(--day-col-width) } .col-hour{ width:calc((100% - var(--day-col-width))/15) } /* 8:00‚Äì23:00 */
    thead th{ position:sticky; top:0; z-index:1; background:#F7FAFC; color:#0F172A; font:800 .95rem 'Montserrat',sans-serif; text-align:center; padding:12px 6px; border-bottom:1px solid var(--line) }
    th.day-col{ position:sticky; left:0; z-index:3; background:#E7F4FF; color:#0B2436; border-right:1px solid var(--line) }
    tbody td, tbody th{ border-top:1px solid var(--line); border-right:1px solid var(--line) }
    tbody td:last-child{ border-right:0 }
    .time-slot{ display:flex; height:var(--row-height); width:100% }
    .half-hour-slot{
      flex:1; display:flex; align-items:center; justify-content:center;
      /* ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏≠: ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà/‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
      white-space: normal; text-overflow: clip; overflow:hidden;
      font-size:.72rem; /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏à‡∏≤‡∏Å .8rem */
      color:#64748B; cursor:pointer; user-select:none;
      transition:background-color .12s, box-shadow .12s, transform .06s;
      border-right:1px solid var(--line); padding:0 1px; /* ‡πÄ‡∏î‡∏¥‡∏° 0 2px */
      text-align:center;
    }
    .half-hour-slot:last-child{ border-right:0 }
    .half-hour-slot:hover:not(.selected-user):not(.ai-reading-time):not(.ai-rest):not(.ai-meal):not(.ai-social):not(.ai-bed){ background:var(--blue-soft) }
    .selected-user{ background:#0288D1!important; color:#fff!important; font-weight:800 }
    .ai-rest{ background:#22C55E!important; color:#fff!important; font-weight:800 }
    .ai-reading-time{ background:#F59E0B!important; color:#fff!important; font-weight:800 }
    .ai-meal{ background:#14B8A6!important; color:#fff!important; font-weight:800 }
    .ai-social{ background:#8B5CF6!important; color:#fff!important; font-weight:800 }
    .ai-bed{ background:#475569!important; color:#fff!important; font-weight:800 }

    .toast{ position:fixed; bottom:16px; right:16px; background:#0F172A; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none; transform:translateY(8px); transition:.25s }
    .toast.show{ opacity:1; transform:translateY(0) }

    /* ‚Äî ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‚Äî */
    .reco{ margin-top:28px }
    .reco-header{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:10px }
    .reco-title{ margin:0; font:800 1.18rem 'Montserrat',sans-serif }
    .reco-sub{ margin:4px 0 0; color:#6B7A90; font-weight:600; font-size:.95rem }
    .reco-toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:12px 0 16px; }
    .chip{ border:1px solid var(--line); background:#fff; color:#0B2436; border-radius:999px; padding:8px 12px; font-weight:700; cursor:pointer; transition:.15s background,.15s color,.15s border-color; user-select:none; }
    .chip[aria-pressed="true"]{ background:#0EA5E9; color:#fff; border-color:#0EA5E9 }
    .chip[data-cat="eat"]::before{ content:"üçú "; } 
    .chip[data-cat="fun"]::before{ content:"üé≤ "; }
    .reco-search{ margin-left:auto; position:relative; display:flex; align-items:center; background:#fff; border:1px solid var(--line); border-radius:12px; padding:6px 10px; gap:8px }
    .reco-search input{ border:0; outline:none; background:transparent; min-width:220px; font-size:.95rem }
    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(270px,1fr)); gap:16px }
    .card{ background:#fff; border:1px solid var(--line); border-radius:16px; overflow:hidden; box-shadow:var(--shadow); display:flex; flex-direction:column; transition:.18s transform,.2s box-shadow; }
    .card:hover{ transform:translateY(-3px); box-shadow:0 14px 30px rgba(10,134,212,.12) }
    .card-banner{ position:relative; height:156px; background:#F2F6FB }
    .card-img{ height:100%; width:100%; object-fit:cover; display:block }
    .badge{ position:absolute; top:10px; left:10px; padding:6px 10px; border-radius:999px; font-weight:800; font-size:.78rem; color:#0B2436; background:#FFFFFFE6; border:1px solid #EEF2F6; backdrop-filter: blur(6px); }
    .badge.eat, .badge.fun{ color:#0B2536; }
    .card-body{ padding:12px 12px 16px; display:flex; flex-direction:column; gap:8px; flex:1 }
    .card h3{ margin:0; font:800 1.02rem 'Montserrat',sans-serif }
    .card p{ margin:0; color:#4B5A73 }
    .meta{ display:flex; gap:8px; flex-wrap:wrap; margin-top:2px }
    .tag{ font-size:.78rem; font-weight:800; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#F8FAFE; color:#0B2536; }
    .map-link{ margin-top:auto; align-self:flex-start; text-decoration:none; background:#0EA5E9; color:#fff; padding:8px 12px; border-radius:10px; font-weight:800; }
    .map-link:hover{ background:#0A86D4 }

    @media (max-width:720px){
      :root{ --day-col-width:120px; --row-height:52px }
      .title-wrap h1{ font-size:1.06rem }
      .dashboard .steps{ display:none }
      .reco-search input{ min-width:140px }
    }

    /* --- ‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ (‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î/‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà) --- */
    .slot-label{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      line-height:1.02;                 /* ‡πÄ‡∏î‡∏¥‡∏° 1.05 */
      width:100%; padding:1px 1px;      /* ‡πÄ‡∏î‡∏¥‡∏° 2px 1px */
      text-shadow:0 1px 0 rgba(0,0,0,.15);
    }
    .slot-label .slot-type{
      font-weight:800;
      font-size:clamp(.62rem, 0.80vw, .78rem);   /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
    }
    .slot-label .slot-time{
      font-weight:800;
      font-size:clamp(.70rem, 0.95vw, .85rem);   /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
      letter-spacing:.18px;
    }
    /* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏µ */
    .ai-reading-time .slot-label, .ai-rest .slot-label, .ai-meal .slot-label,
    .ai-social .slot-label, .ai-bed .slot-label{
      border:1px solid rgba(255,255,255,.25); border-radius:10px;
    }
  </style>
</head>
<body>

<!-- ---------- START PAGE ---------- -->
<div id="startPage" class="start-page bg-blobs" role="dialog" aria-labelledby="heroTitle" aria-describedby="heroDesc">
  <div class="hero-min" >
    <div class="brand-badge" aria-hidden="true">A</div>
    <h1 id="heroTitle">AI Time Planner</h1>
    <p id="heroDesc">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏î‡∏∏‡∏•</p>
    <button class="cta" onclick="hideStartPage()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô</button>
  </div>
</div>

<!-- ---------- TOP BAR ---------- -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo">A</div>
      <div class="title-wrap">
        <h1>AI Time Planner</h1>
        <p>‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏î‡∏∏‡∏•</p>
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-ghost" onclick="openGoalInput()">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</button>
      <button class="btn btn-primary" onclick="runAIScheduling()">üß† ‡πÉ‡∏´‡πâ AI ‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
      <button class="btn btn-ghost" onclick="downloadScheduleImage()">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á (.png)</button>
      <button class="btn btn-danger" onclick="clearSchedule()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>
  </div>
</div>

<!-- ---------- MAIN ---------- -->
<div class="container" id="mainContent" style="display:none">
  <div class="dashboard">
    <div class="steps">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô: 1) ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏™‡πà ‚Äú‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‚Äù ‚Üí 2) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 12:00‚Äì15:00 ‡∏´‡∏£‡∏∑‡∏≠ 17:00‚Äì20:00 ‚Üí 3) ‡πÉ‡∏´‡πâ AI ‡πÄ‡∏ï‡∏¥‡∏° ‚Äú‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏≠‡πà‡∏≤‡∏ô/‡∏û‡∏±‡∏Å-‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß/‡∏™‡∏±‡∏á‡∏Ñ‡∏°/‡∏ô‡∏≠‡∏ô‚Äù</div>
    <div class="controls">
      <label for="weekday-preference" style="font-weight:800">‡∏ä‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≤‡∏ô (‡∏à.-‡∏®.):</label>
      <select id="weekday-preference">
        <option value="lunch">12:00‚Äì15:00</option>
        <option value="evening">17:00‚Äì20:00</option>
      </select>
    </div>
  </div>

  <!-- ============ ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Capture ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û ============ -->
  <div id="schedule-capture">
    <div class="legend">
      <div class="legend-item"><span class="color c-class"></span>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
      <div class="legend-item"><span class="color c-meal"></span>‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡πÄ‡∏ä‡πâ‡∏≤/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á/‡πÄ‡∏¢‡πá‡∏ô)</div>
      <div class="legend-item"><span class="color c-read"></span>‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</div>
      <div class="legend-item"><span class="color c-rest"></span>‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
      <div class="legend-item"><span class="color c-social"></span>‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô/‡πÄ‡∏•‡πà‡∏ô‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•</div>
      <div class="legend-item"><span class="color c-bed"></span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡∏≠‡∏ô (22:30)</div>
    </div>

    <div class="table-wrap">
      <table class="schedule-table" aria-label="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤">
        <colgroup>
          <col class="col-day" />
          <!-- 8:00‚Äì23:00 = 15 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå -->
          <col class="col-hour" /><col class="col-hour" /><col class="col-hour" /><col class="col-hour" />
          <col class="col-hour" /><col class="col-hour" /><col class="col-hour" /><col class="col-hour" />
          <col class="col-hour" /><col class="col-hour" /><col class="col-hour" /><col class="col-hour" />
          <col class="col-hour" /><col class="col-hour" /><col class="col-hour" />
        </colgroup>
        <thead>
          <tr>
            <th class="day-col">‡∏ß‡∏±‡∏ô / ‡πÄ‡∏ß‡∏•‡∏≤</th>
            <th>8:00‚Äì9:00</th><th>9:00‚Äì10:00</th><th>10:00‚Äì11:00</th><th>11:00‚Äì12:00</th>
            <th>12:00‚Äì13:00</th><th>13:00‚Äì14:00</th><th>14:00‚Äì15:00</th><th>15:00‚Äì16:00</th>
            <th>16:00‚Äì17:00</th><th>17:00‚Äì18:00</th><th>18:00‚Äì19:00</th><th>19:00‚Äì20:00</th>
            <th>20:00‚Äì21:00</th><th>21:00‚Äì22:00</th><th>22:00‚Äì23:00</th>
          </tr>
        </thead>
        <tbody id="schedule-body"></tbody>
      </table>
    </div>
  </div>

  <!-- ================== ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡∏Ñ‡∏£‡∏ö 4 ‡πÅ‡∏´‡πà‡∏á) ================== -->
  <section class="reco" aria-labelledby="recoTitle">
    <div class="reco-header">
      <div>
        <h2 id="recoTitle" class="reco-title">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏Å‡∏•‡πâ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô</h2>
        <p class="reco-sub">‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà AI ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á!</p>
      </div>
    </div>

    <div class="reco-toolbar" role="group" aria-label="‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà">
      <button class="chip" data-cat="all" aria-pressed="true">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button class="chip" data-cat="eat" aria-pressed="false">‡∏Å‡∏¥‡∏ô‡∏î‡∏µ</button>
      <button class="chip" data-cat="fun" aria-pressed="false">‡∏™‡∏ô‡∏∏‡∏Å</button>

      <label class="reco-search" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô">
        üîé
        <input type="search" id="recoSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢">
      </label>
    </div>

    <div id="recoGrid" class="grid">
      <!-- 1) Board Game Everyday Cafe -->
      <article class="card" data-cat="fun" data-title="board game everyday cafe ‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏Å‡∏°" data-desc="‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏á‡∏°‡∏Ç. ‡πÄ‡∏Å‡∏°‡πÄ‡∏¢‡∏≠‡∏∞‡∏Å‡∏ß‡πà‡∏≤ 200 ‡πÄ‡∏Å‡∏° ‡πÑ‡∏õ‡∏™‡∏ô‡∏∏‡∏Å‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ">
        <div class="card-banner">
          <img class="card-img" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSyRz-fZCSBQ4yRE-517wiU-zfMwvJPl0cdFirWykfNu6K-vjVkG6k3yy0bAONtufSCFbw&usqp=CAU" alt="Board Game Everyday Cafe" crossorigin="anonymous">
          <span class="badge fun">üé≤ ‡∏™‡∏ô‡∏∏‡∏Å</span>
        </div>
        <div class="card-body">
          <h3>Board Game Everyday Cafe (‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏Å‡∏°)</h3>
          <p>‡∏£‡πâ‡∏≤‡∏ô‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÄ‡∏Å‡∏°‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°‡∏´‡∏•‡∏±‡∏á ‡∏°‡∏Ç. ‡∏°‡∏µ‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏¢‡∏≠‡∏∞‡∏Å‡∏ß‡πà‡∏≤ 200 ‡πÄ‡∏Å‡∏° ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÜ</p>
          <div class="meta"><span class="tag">‡∏´‡∏•‡∏±‡∏á ‡∏°‡∏Ç.</span><span class="tag">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ</span></div>
          <a class="map-link" target="_blank" href="https://www.google.com/maps/search/Board+Game+Everyday+Cafe+‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô">‡∏î‡∏π‡∏ö‡∏ô Google Map</a>
        </div>
      </article>

      <!-- 2) ‡∏ô‡∏≤‡∏¢‡∏ï‡∏≠‡∏á‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞ -->
      <article class="card" data-cat="eat" data-title="‡∏ô‡∏≤‡∏¢‡∏ï‡∏≠‡∏á‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞ ‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡∏ï‡πå ‡πÇ‡∏ô‡∏ô‡∏°‡πà‡∏ß‡∏á" data-desc="‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡∏ï‡πå‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤ ‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡πÇ‡∏•‡πà‡∏á‡∏™‡∏ö‡∏≤‡∏¢ ‡∏¢‡πà‡∏≤‡∏ô‡πÇ‡∏ô‡∏ô‡∏°‡πà‡∏ß‡∏á ‡∏´‡∏•‡∏±‡∏á ‡∏°‡∏Ç.">
        <div class="card-banner">
          <img class="card-img" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRhUxvzhRKambCCH5UgEkShKpybOcgJi8U08w&s" alt="‡∏ô‡∏≤‡∏¢‡∏ï‡∏≠‡∏á ‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞" crossorigin="anonymous">
          <span class="badge eat">üçú ‡∏Å‡∏¥‡∏ô‡∏î‡∏µ</span>
        </div>
        <div class="card-body">
          <h3>‡∏ô‡∏≤‡∏¢‡∏ï‡∏≠‡∏á‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞ (‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡∏ï‡πå‡∏´‡∏•‡∏±‡∏á ‡∏°‡∏Ç.)</h3>
          <p>‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡∏ï‡πå‡∏´‡∏°‡∏π‡∏Å‡∏£‡∏∞‡∏ó‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‡πÇ‡∏•‡πà‡∏á‡∏™‡∏ö‡∏≤‡∏¢ ‡∏¢‡πà‡∏≤‡∏ô‡πÇ‡∏ô‡∏ô‡∏°‡πà‡∏ß‡∏á ‡∏´‡∏•‡∏±‡∏á ‡∏°‡∏Ç.</p>
          <div class="meta"><span class="tag">‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡∏ï‡πå</span><span class="tag">‡∏´‡∏•‡∏±‡∏á ‡∏°‡∏Ç.</span></div>
          <a class="map-link" target="_blank" href="https://www.google.com/maps/place/%E0%B8%99%E0%B8%B2%E0%B8%A2%E0%B8%95%E0%B8%AD%E0%B8%87+%E0%B8%AB%E0%B8%A1%E0%B8%B9%E0%B8%81%E0%B8%A3%E0%B8%B0%E0%B8%97%E0%B8%B0">‡∏î‡∏π‡∏ö‡∏ô Google Map</a>
        </div>
      </article>

      <!-- 3) Midnight Soon -->
      <article class="card" data-cat="eat" data-title="midnight soon ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á ‡∏Å‡∏±‡∏á‡∏™‡∏î‡∏≤‡∏•" data-desc="‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏ß‡∏±‡∏ç‡πÉ‡∏à‡πÄ‡∏î‡πá‡∏Å‡∏°‡∏Ç. ‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡πà‡∏ô ‡∏≠‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡πâ‡∏° ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÜ">
        <div class="card-banner">
          <img class="card-img" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQveZsMViGDi48bv9Svqp5B88NWyfDS_xF55Q&s" alt="Midnight Soon" crossorigin="anonymous">
          <span class="badge eat">üçú ‡∏Å‡∏¥‡∏ô‡∏î‡∏µ</span>
        </div>
        <div class="card-body">
          <h3>Midnight Soon (‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏±‡πà‡∏á/‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏ß)</h3>
          <p>‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ç‡∏ß‡∏±‡∏ç‡πÉ‡∏à‡πÄ‡∏î‡πá‡∏Å ‡∏°‡∏Ç. ‡∏¢‡πà‡∏≤‡∏ô‡∏Å‡∏±‡∏á‡∏™‡∏î‡∏≤‡∏• ‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡πà‡∏ô ‡∏≠‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡πâ‡∏° ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡πá‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡πÜ</p>
          <div class="meta"><span class="tag">‡∏Å‡∏±‡∏á‡∏™‡∏î‡∏≤‡∏•</span><span class="tag">‡∏≠‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡πâ‡∏°</span></div>
          <a class="map-link" target="_blank" href="https://www.google.com/maps/search/Midnight+soon+‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£+‡∏Å‡∏±‡∏á‡∏™‡∏î‡∏≤‡∏•‡∏°‡∏Ç">‡∏î‡∏π‡∏ö‡∏ô Google Map</a>
        </div>
      </article>

      <!-- 4) ‡πÅ‡∏ã‡πà‡∏ö‡∏¢‡∏Å‡∏Ñ‡∏£‡∏Å -->
      <article class="card" data-cat="eat" data-title="‡πÅ‡∏ã‡πà‡∏ö‡∏¢‡∏Å‡∏Ñ‡∏£‡∏Å ‡∏™‡πâ‡∏°‡∏ï‡∏≥ ‡∏õ‡∏•‡∏≤‡πÄ‡∏ú‡∏≤" data-desc="‡∏™‡πâ‡∏°‡∏ï‡∏≥‚Äì‡∏õ‡∏•‡∏≤‡πÄ‡∏ú‡∏≤ ‡πÅ‡∏ã‡πà‡∏ö‡∏ô‡∏±‡∏ß ‡πÉ‡∏Å‡∏•‡πâ ‡∏°‡∏Ç. ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡πÅ‡∏ß‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏•‡∏±‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏±‡∏Å">
        <div class="card-banner">
          <img class="card-img" src="https://p16-lemon8-sign-sg.tiktokcdn.com/tos-alisg-v-a3e477-sg/oMk6TaQEAXtUAQcIaCFoE6EDgUUfABACfXn9d0~tplv-sdweummd6v-text-logo-v1:QHBpa3Vua2Vhdw==:q75.jpeg?lk3s=c7f08e79&source=lemon8_seo&x-expires=1762214400&x-signature=1hGxe6MBaiQEY54ZDjvPWy3Q1UE%3D" alt="‡πÅ‡∏ã‡πà‡∏ö‡∏¢‡∏Å‡∏Ñ‡∏£‡∏Å" crossorigin="anonymous">
          <span class="badge eat">üçú ‡∏Å‡∏¥‡∏ô‡∏î‡∏µ</span>
        </div>
        <div class="card-body">
          <h3>‡πÅ‡∏ã‡πà‡∏ö‡∏¢‡∏Å‡∏Ñ‡∏£‡∏Å ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô (‡∏£‡πâ‡∏≤‡∏ô‡∏™‡πâ‡∏°‡∏ï‡∏≥)</h3>
          <p>‡∏™‡πâ‡∏°‡∏ï‡∏≥‚Äì‡∏õ‡∏•‡∏≤‡πÄ‡∏ú‡∏≤ ‡πÅ‡∏ã‡πà‡∏ö‡∏ô‡∏±‡∏ß ‡πÉ‡∏Å‡∏•‡πâ ‡∏°‡∏Ç. ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡πÅ‡∏ß‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏•‡∏±‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å</p>
          <div class="meta"><span class="tag">‡∏≠‡∏µ‡∏™‡∏≤‡∏ô‡πÅ‡∏ã‡πà‡∏ö</span><span class="tag">‡πÉ‡∏Å‡∏•‡πâ ‡∏°‡∏Ç.</span></div>
          <a class="map-link" target="_blank" href="https://www.google.com/maps/search/‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏ã‡πà‡∏ö‡∏¢‡∏Å‡∏Ñ‡∏£‡∏Å‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô">‡∏î‡∏π‡∏ö‡∏ô Google Map</a>
        </div>
      </article>
    </div>
  </section>
</div>

<!-- Toast -->
<div id="toast" class="toast">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>

<script>
/* ================== CONFIG / POLICY ================== */
const POLICY = {
  weekdayPrefSelector: '#weekday-preference',
  readingNormalSlots: 6,      // 3 ‡∏ä‡∏°./‡∏ß‡∏±‡∏ô (30 ‡∏ô‡∏≤‡∏ó‡∏µ/‡∏ä‡πà‡∏≠‡∏á)
  readingHeavySlots: 3,       // ‚â§1.5 ‡∏ä‡∏°./‡∏ß‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô >5 ‡∏ä‡∏°.
  restNormalSlots: 3,         // 1.5 ‡∏ä‡∏°./‡∏ß‡∏±‡∏ô
  restHeavySlots: 6,          // 3 ‡∏ä‡∏°./‡∏ß‡∏±‡∏ô (‡∏ß‡∏±‡∏ô‡∏´‡∏ô‡∏±‡∏Å)
  meals: { breakfast: 800, lunch: 1200, dinner: 1800 }, // 1 ‡∏ä‡∏°./‡∏°‡∏∑‡πâ‡∏≠
  mealSearchRange: 120,       // ‡∏Ç‡∏¢‡∏±‡∏ö‡πÑ‡∏î‡πâ ¬±2 ‡∏ä‡∏°.
  bedtime: 2230,              // 22:30 ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡∏≠‡∏ô
  socialWeekdayHours: 2,      // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏ä‡∏°.
  weekendSocial: { start: 1600, end: 1800 }, // ‡∏™.-‡∏≠‡∏≤. 16:00‚Äì18:00
  readingWindows: {
    lunch:  { start: 1200, end: 1500 },      // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    evening:{ start: 1700, end: 2000 }
  }
};

/* ---------- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∏à-‡∏≠‡∏≤ (8:00‚Äì23:00) ---------- */
const DAYS = [
  ['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','M'],['‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','T'],['‡∏û‡∏∏‡∏ò','W'],['‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ','Th'],
  ['‡∏®‡∏∏‡∏Å‡∏£‡πå','F'],['‡πÄ‡∏™‡∏≤‡∏£‡πå','Sa'],['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','Su']
];
const HOURS = [800,900,1000,1100,1200,1300,1400,1500,1600,1700,1800,1900,2000,2100,2200];

function tdFor(day, t){
  return `
    <td>
      <div class="time-slot">
        <div class="half-hour-slot" data-day="${day}" data-time="${t}"></div>
        <div class="half-hour-slot" data-day="${day}" data-time="${t+30}"></div>
      </div>
    </td>`;
}
(function buildTable(){
  const tbody = document.getElementById('schedule-body');
  tbody.innerHTML = DAYS.map(([label,key])=>{
    return `<tr>
      <th class="day-col">${label}</th>
      ${HOURS.map(h=>tdFor(key,h)).join('')}
    </tr>`;
  }).join('');
})();

/* ---------- Utils ---------- */
let slots = [];
const startPage = document.getElementById('startPage');
const mainContent = document.getElementById('mainContent');
const toastEl = document.getElementById('toast');

document.addEventListener('DOMContentLoaded', () => {
  slots = Array.from(document.querySelectorAll('.half-hour-slot'));
  setupSlotListeners();
  clearAISlots();
});

function showToast(msg='‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), 1900);
}
function formatTimeCode(code){ const s = String(code).padStart(4,'0'); return `${s.slice(0,2)}:${s.slice(2)}`; }
function add30(code){ const h=Math.floor(code/100), m=code%100; const nm=m+30; return nm>=60 ? (h+1)*100+(nm-60) : h*100+nm; }
function range30(start,count){ const arr=[]; let t=start; for(let i=0;i<count;i++){ arr.push(t); t=add30(t); } return arr; }

/* === ‡∏õ‡πâ‡∏≤‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ === */
function labelHTML(type, startCode){
  const endCode = add30(startCode);
  return `<div class="slot-label" aria-label="${type} ${formatTimeCode(startCode)}-${formatTimeCode(endCode)}">
            <div class="slot-type">${type}</div>
            <div class="slot-time">${formatTimeCode(startCode)}‚Äì${formatTimeCode(endCode)}</div>
          </div>`;
}

/* === ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏á / ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ === */
function getDaySlots(dayKey){ return slots.filter(s=>s.dataset.day===dayKey); }
function getSlot(dayKey, timeCode){ return slots.find(s=>s.dataset.day===dayKey && parseInt(s.dataset.time)===timeCode); }
function isFree(slot){
  return slot &&
    !slot.classList.contains('selected-user') &&
    !slot.classList.contains('ai-reading-time') &&
    !slot.classList.contains('ai-rest') &&
    !slot.classList.contains('ai-meal') &&
    !slot.classList.contains('ai-social') &&
    !slot.classList.contains('ai-bed');
}
function mark(slot, cls, type, startCode){
  if(!slot || !isFree(slot)) return false;
  slot.classList.add(cls);
  slot.innerHTML = labelHTML(type, startCode);
  return true;
}
function clearAISlots(){
  slots.forEach(slot=>{
    if (!slot.classList.contains('selected-user')){
      slot.classList.remove('ai-reading-time','ai-rest','ai-meal','ai-social','ai-bed');
      slot.textContent = '';
    } else {
      const t=parseInt(slot.dataset.time);
      slot.innerHTML = labelHTML('‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', t);
    }
  });
}

/* ---------- Manual class marking ---------- */
function setupSlotListeners(){
  slots.forEach(slot=>{
    slot.onclick = function(){
      if (slot.classList.contains('ai-reading-time') || slot.classList.contains('ai-rest') ||
          slot.classList.contains('ai-meal') || slot.classList.contains('ai-social') || slot.classList.contains('ai-bed')) return;
      const sel = slot.classList.toggle('selected-user');
      const t = parseInt(slot.dataset.time);
      slot.innerHTML = sel ? labelHTML('‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', t) : '';
    };
  });
}

/* ---------- Public buttons ---------- */
window.clearSchedule = () => {
  if (!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  slots.forEach(s=>{ s.className='half-hour-slot'; s.textContent=''; });
  setupSlotListeners();
  showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß');
};

window.openGoalInput = () => {
  alert(`üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ AI (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô POLICY)

‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥: ‡∏≠‡πà‡∏≤‡∏ô 3 ‡∏ä‡∏°./‡∏ß‡∏±‡∏ô | ‡∏û‡∏±‡∏Å/‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß 1.5 ‡∏ä‡∏°./‡∏ß‡∏±‡∏ô
‚Ä¢ ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏ô‡∏±‡∏Å (>5 ‡∏ä‡∏°.): ‡∏≠‡πà‡∏≤‡∏ô ‚â§ 1.5 ‡∏ä‡∏°./‡∏ß‡∏±‡∏ô | ‡∏û‡∏±‡∏Å/‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß 3 ‡∏ä‡∏°./‡∏ß‡∏±‡∏ô
‚Ä¢ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£: ‡πÄ‡∏ä‡πâ‡∏≤ ${formatTimeCode(POLICY.meals.breakfast)}, ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á ${formatTimeCode(POLICY.meals.lunch)}, ‡πÄ‡∏¢‡πá‡∏ô ${formatTimeCode(POLICY.meals.dinner)} (1 ‡∏ä‡∏°./‡∏°‡∏∑‡πâ‡∏≠)
‚Ä¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°: ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏ä‡∏°. (‡∏à.-‡∏®. ‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≤‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢, ‡∏™.-‡∏≠‡∏≤. 16:00‚Äì18:00)
‚Ä¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡∏≠‡∏ô: 22:30 ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô
‚Ä¢ ‡∏ä‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≤‡∏ô (‡∏à.-‡∏®.) ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å`);
};

/* --- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô --- */
window.hideStartPage = () => {
  startPage.classList.add('hidden');
  setTimeout(()=>{ startPage.style.display='none'; mainContent.style.display='block'; }, 550);
};

/* ================== Core helpers ================== */
function dayReport(dayKey){
  const daySlots = getDaySlots(dayKey);
  const classSlots = daySlots.filter(s=>s.classList.contains('selected-user'));
  const classHours = classSlots.length * 0.5;
  const lastClass = classSlots.length ? Math.max(...classSlots.map(s=>parseInt(s.dataset.time))) : null;
  return {classSlots, classHours, lastClass};
}

function placeContiguous(dayKey, startTime, count, cls, textPrefix, hardEnd=null){
  // ‡∏ß‡∏≤‡∏á block ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á count ‡∏ä‡πà‡∏≠‡∏á ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å startTime
  let t = startTime;
  while(true){
    const endTime = range30(t, count).slice(-1)[0];
    if (hardEnd && add30(endTime) > hardEnd) return null;
    const ok = range30(t, count).every(code=> isFree(getSlot(dayKey, code)));
    if (ok){
      const used = [];
      for(const code of range30(t, count)){
        const slot = getSlot(dayKey, code);
        slot.classList.add(cls);
        slot.innerHTML = labelHTML(textPrefix, code);
        used.push(slot);
      }
      return {start:t, end:add30(endTime), slots:used};
    }
    t = add30(t);
    if (t >= 2300) break;
  }
  return null;
}

function placeWithinWindow(dayKey, winStart, winEnd, count, cls, textPrefix){
  // ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  let t = winStart;
  while (add30(t) <= winEnd){
    const endTime = range30(t, count).slice(-1)[0];
    if (add30(endTime) > winEnd) break;
    const ok = range30(t, count).every(code=> isFree(getSlot(dayKey, code)));
    if (ok){
      const used = [];
      for(const code of range30(t, count)){
        const slot = getSlot(dayKey, code);
        slot.classList.add(cls);
        slot.innerHTML = labelHTML(textPrefix, code);
        used.push(slot);
      }
      return {start:t, end:add30(endTime), slots:used};
    }
    t = add30(t);
  }
  // ‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô
  for (let k=count-1; k>=1; k--){
    let tryT = winStart;
    while (add30(tryT) <= winEnd){
      const endTime = range30(tryT, k).slice(-1)[0];
      if (add30(endTime) > winEnd) break;
      const ok = range30(tryT, k).every(code=> isFree(getSlot(dayKey, code)));
      if (ok){
        for(const code of range30(tryT, k)){
          const slot = getSlot(dayKey, code);
          slot.classList.add(cls);
          slot.innerHTML = labelHTML(textPrefix, code);
        }
        showToast('‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏ß‡∏≤‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô');
        return {start:tryT, end:add30(endTime), partial:true};
      }
      tryT = add30(tryT);
    }
  }
  showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
  return null;
}

function placeMeal(dayKey, targetStart){
  // 1 ‡∏ä‡∏°. (2 ‡∏ä‡πà‡∏≠‡∏á) ‡∏Ç‡∏¢‡∏±‡∏ö‡πÑ‡∏î‡πâ
  const candidates=[];
  let t=targetStart; while (t<=targetStart+POLICY.mealSearchRange){ candidates.push(t); t=add30(t); }
  t=targetStart-30; while (t>=targetStart-POLICY.mealSearchRange){ candidates.push(t); t-=30; }
  for(const cand of candidates){
    const ok = range30(cand,2).every(code=> isFree(getSlot(dayKey, code)));
    if(ok){
      range30(cand,2).forEach(code=>{
        const slot=getSlot(dayKey, code);
        mark(slot,'ai-meal','‡∏≠‡∏≤‡∏´‡∏≤‡∏£', code);
      });
      return true;
    }
  }
  return false;
}

function placeRestAfter(dayKey, afterTime, count=1){
  return placeContiguous(dayKey, afterTime, count, 'ai-rest', '‡∏û‡∏±‡∏Å/‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß');
}

function placeSocialWeekday(dayKey, lastClassTime){
  if(lastClassTime===null) return null;
  const need = POLICY.socialWeekdayHours*2; // 2 ‡∏ä‡∏°.
  return placeContiguous(dayKey, add30(lastClassTime), need, 'ai-social', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°', 2300);
}

function placeSocialWeekend(dayKey){
  return placeContiguous(dayKey, POLICY.weekendSocial.start, 4, 'ai-social', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏±‡∏á‡∏Ñ‡∏°', POLICY.weekendSocial.end);
}

function placeBedtime(dayKey){
  const bed = getSlot(dayKey, POLICY.bedtime);
  if (bed && isFree(bed)){
    bed.classList.add('ai-bed');
    bed.innerHTML = `<div class="slot-label"><div class="slot-type">‡πÄ‡∏Ç‡πâ‡∏≤‡∏ô‡∏≠‡∏ô</div><div class="slot-time">22:30‚Äì23:00</div></div>`;
  }
}

/* ================== Scheduling per day ================== */
function scheduleDay(dayKey, preference){
  const {classHours, lastClass} = dayReport(dayKey);
  const isWeekend = (dayKey==='Sa' || dayKey==='Su');

  const readingTarget = classHours>5 ? POLICY.readingHeavySlots : POLICY.readingNormalSlots;
  const restTarget   = classHours>5 ? POLICY.restHeavySlots   : POLICY.restNormalSlots;

  // 1) ‡∏≠‡∏≤‡∏´‡∏≤‡∏£
  placeMeal(dayKey, POLICY.meals.breakfast);
  placeMeal(dayKey, POLICY.meals.lunch);
  placeMeal(dayKey, POLICY.meals.dinner);

  // 2) ‡∏™‡∏±‡∏á‡∏Ñ‡∏°
  if (isWeekend){ placeSocialWeekend(dayKey); }
  else { placeSocialWeekday(dayKey, lastClass); }

  // 3) ‡∏≠‡πà‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏à.-‡∏®.) ‡∏´‡∏£‡∏∑‡∏≠ 10:00‚Äì20:00 (‡∏™.-‡∏≠‡∏≤.)
  let readingPlaced=null;
  if (!isWeekend){
    const win = POLICY.readingWindows[preference];
    readingPlaced = placeWithinWindow(dayKey, win.start, win.end, readingTarget, 'ai-reading-time', '‡∏≠‡πà‡∏≤‡∏ô');
  }else{
    readingPlaced = placeWithinWindow(dayKey, 1000, 2000, readingTarget, 'ai-reading-time', '‡∏≠‡πà‡∏≤‡∏ô');
  }

  // 4) ‡∏û‡∏±‡∏Å/‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏™‡∏°‡∏≠
  if (readingPlaced){
    placeRestAfter(dayKey, readingPlaced.end, 1);
  }

  // 5) ‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏±‡∏Å/‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤ (‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏±‡πà‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏≠‡πà‡∏≤‡∏ô)
  const daySlots = getDaySlots(dayKey);
  const currentRest = daySlots.filter(s=>s.classList.contains('ai-rest')).length;
  let needMore = Math.max(0, restTarget - currentRest);

  let t = 800;
  while (needMore>0 && t<2230){
    const slot = getSlot(dayKey, t);
    if (slot && isFree(slot)){
      const prev = getSlot(dayKey, t-30);
      const next = getSlot(dayKey, add30(t));
      const prevIsRead = prev && prev.classList.contains('ai-reading-time');
      const nextIsRead = next && next.classList.contains('ai-reading-time');
      if (!(prevIsRead && nextIsRead)){
        mark(slot,'ai-rest','‡∏û‡∏±‡∏Å/‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß', t);
        needMore--;
      }
    }
    t = add30(t);
  }

  // 6) ‡∏ô‡∏≠‡∏ô
  placeBedtime(dayKey);
}

window.runAIScheduling = () => {
  clearAISlots();
  const preference = document.querySelector(POLICY.weekdayPrefSelector).value;

  DAYS.forEach(([_, key])=> scheduleDay(key, preference));

  const summary = DAYS.map(([label,key])=>{
    const daySlots = getDaySlots(key);
    const mins = (cls)=> daySlots.filter(s=>s.classList.contains(cls)).length * 30;
    const h = m => (m/60).toFixed(1);
    return `‚Ä¢ ${label} ‚Äî ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${h(mins('selected-user'))} ‡∏ä‡∏°., ‡∏≠‡πà‡∏≤‡∏ô: ${h(mins('ai-reading-time'))} ‡∏ä‡∏°., ‡∏û‡∏±‡∏Å/‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß: ${h(mins('ai-rest'))} ‡∏ä‡∏°., ‡∏™‡∏±‡∏á‡∏Ñ‡∏°: ${h(mins('ai-social'))} ‡∏ä‡∏°.`;
  }).join('\n');

  showToast('AI ‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
  alert(`‚úÖ ‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n\n${summary}\n\n‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ß‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô`);
};

/* --- ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏£‡∏≤‡∏á --- */
window.downloadScheduleImage = async () => {
  const captureEl = document.getElementById('schedule-capture');
  const tableWrap = captureEl.querySelector('.table-wrap');
  const prevScroll = tableWrap.scrollLeft || 0;
  tableWrap.scrollLeft = 0;
  await new Promise(r=>setTimeout(r,50));
  try{
    const canvas = await html2canvas(captureEl, {
      scale: 2, backgroundColor:'#FFFFFF', useCORS:true, logging:false,
      windowWidth: document.documentElement.scrollWidth,
    });
    const a = document.createElement('a');
    const d = new Date();
    const ts = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}`;
    a.download = `AI_Time_Planner_${ts}.png`;
    a.href = canvas.toDataURL('image/png');
    a.click();
    showToast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß');
  }catch(e){
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå');
    console.error(e);
  }finally{
    tableWrap.scrollLeft = prevScroll;
  }
};

/* ================== Store Filter (UI only) ================== */
(function storeFilter(){
  const chips = document.querySelectorAll('.reco-toolbar .chip');
  const grid = document.getElementById('recoGrid');
  const cards = Array.from(grid.querySelectorAll('.card'));
  const search = document.getElementById('recoSearch');

  function applyFilter(){
    const active = document.querySelector('.reco-toolbar .chip[aria-pressed="true"]')?.dataset.cat || 'all';
    const q = (search.value || '').trim().toLowerCase();
    cards.forEach(card=>{
      const cat = card.dataset.cat;
      const text = `${card.dataset.title} ${card.dataset.desc}`.toLowerCase();
      const matchCat = (active==='all') || (cat===active);
      const matchText = q==='' || text.includes(q);
      card.style.display = (matchCat && matchText) ? '' : 'none';
    });
  }

  chips.forEach(chip=>{
    chip.addEventListener('click', ()=>{
      chips.forEach(c=>c.setAttribute('aria-pressed','false'));
      chip.setAttribute('aria-pressed','true');
      applyFilter();
    });
  });
  search.addEventListener('input', applyFilter);
})();
</script>
</body>
</html>
